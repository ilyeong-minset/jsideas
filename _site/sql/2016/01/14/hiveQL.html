<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>HiveQL - Useful Tips</title>
  <meta name="description" content="a novice's journey into data science
" />

  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="canonical" href="http://localhost:4000/sql/2016/01/14/hiveQL.html">

  <link rel="shortcut icon" href="/assets/images/favicon.ico">
<!--  <link rel="stylesheet" href=""> -->
  <link rel="stylesheet" href="http://brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
  <link rel="stylesheet" type="text/css" media="print" href="/css/print.css" />
</head>

  <body itemscope itemtype="http://schema.org/Article">
    <!-- header start -->

<a href="http://localhost:4000" class="logo-readium"><span class="logo" style="background-image: url(/assets/images/df_logo.jpg)"></span></a>

<!-- header end -->

    <main class="content" role="main">
      <article class="post">
        
        <div class="article-image">
          <div class="post-image-image" style="background-image: url(/assets/hiveql/header.png)">
            Article Image
          </div>
          <div class="post-meta">
            <h1 class="post-title">HiveQL - Useful Tips</h1>
            <div class="cf post-meta-text">
              <div class="author-image" style="background-image: url(/assets/images/author.jpg)">Blog Logo</div>
              <h4 class="author-name" itemprop="author" itemscope itemtype="http://schema.org/Person">Junsik Whang</h4>
              on
              <time datetime="2016-01-14 07:34">14 Jan 2016</time>
              <!-- , tagged on <span class="post-tag-">, <a href="/tag/"></a></span> -->
            </div>
            <div style="text-align:center">
              <a href="#topofpage" class="topofpage"><i class="fa fa-angle-down"></i></a>
            </div>
          </div>
        </div>
        
        <section class="post-content">
          <div class="post-reading">
            <span class="post-reading-time"></span> read
          </div>
          <a name="topofpage"></a>
          <p>파이썬과 더불어 회사 업무를 처리하는데 있어 SQL의 도움을 많이 받는다. 대용량의 데이터가 저장된 시스템에서 원하는 정보를 가져와 가공하는데 정말 좋다. 작년 8월부터 초보적인 Select * From을 쳐가면서 데이터를 뽑기 시작했는데, 모르는 부분을 구글링하다보니 내가 쓰는 SQL은 HiveQL로 MySQL이나 Oracle SQL과는 조금 다른 부분이 있다는 걸 알게 되었다. 언어 자체가 크게 다른 것은 아니고 사투리 정도의 차이가 있는 듯 한데 MySQL에서 지원하는 기능이 HiveQL에서는 돌아가지 않거나, 업무적으로 유용하게 쓰는 함수가 있어 기록을 남겨두고자 한다.</p>

<h2>1. collect_list</h2>

<p>컬럼에 있는 값, 특히 string을 하나로 묶는데 유용하게 사용할 수 있다. 예를 들어 다음과 같은 테이블이 있다고 하자.</p>

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;}
.tg td{font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;}
.tg th{font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;}
.tg .tg-yw4l{vertical-align:top}
</style>

<table class="tg">
  <tr>
    <th class="tg-031e">date</th>
    <th class="tg-yw4l">customer</th>
    <th class="tg-yw4l">item</th>
  </tr>
  <tr>
    <td class="tg-yw4l">2016-01-14</td>
    <td class="tg-yw4l">john</td>
    <td class="tg-yw4l">bread</td>
  </tr>
  <tr>
    <td class="tg-yw4l">2016-01-14</td>
    <td class="tg-yw4l">mark</td>
    <td class="tg-yw4l">milk</td>
  </tr>
  <tr>
    <td class="tg-yw4l">2016-01-14</td>
    <td class="tg-yw4l">john</td>
    <td class="tg-yw4l">beer</td>
  </tr>
  <tr>
    <td class="tg-yw4l">2016-01-14</td>
    <td class="tg-yw4l">kate</td>
    <td class="tg-yw4l">book</td>
  </tr>
</table>

<p><br></p>

<p>마트에서 고객이 물품을 구매한 샘플 데이터셋이다. 날짜와, 고객명, 구매물품으로 되어있다. 장바구니 분석을 하기 위해서 각각의 고객이 구매한 제품의 리스트를 얻고 싶다. 이 상황에서 유용하게 쓸 수 있는 함수가 <code>collect_list</code>다. 말그대로 아이템을 가져다가 리스트로 전환해주는데, 비슷한 <code>collect_set</code>은 중복을 제외한 셋을 반환한다. 중복 허용 여부에 따라 맞는 함수를 사용하면 된다. 분석요건에 따라서 다음과 같은 쿼리를 구성할 수 있다.</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span></span><span class="k">SELECT</span> <span class="nb">date</span><span class="p">,</span> <span class="n">customer</span><span class="p">,</span> <span class="n">COLLECT_LIST</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">AS</span> <span class="n">item_list</span>
<span class="k">FROM</span> <span class="n">sample_dataset</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="nb">date</span><span class="p">,</span> <span class="n">customer</span></code></pre></figure>

<p>이를 통해 각 날짜별로 각 고객이 구매한 아이템 목록을 얻을 수 있다.</p>

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;}
.tg td{font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;}
.tg th{font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;}
.tg .tg-yw4l{vertical-align:top}
</style>

<table class="tg">
  <tr>
    <th class="tg-031e">date</th>
    <th class="tg-yw4l">customer</th>
    <th class="tg-yw4l">item_list</th>
  </tr>
  <tr>
    <td class="tg-yw4l">2016-01-14</td>
    <td class="tg-yw4l">john</td>
    <td class="tg-yw4l">bread, beer</td>
  </tr>
  <tr>
    <td class="tg-yw4l">2016-01-14</td>
    <td class="tg-yw4l">mark</td>
    <td class="tg-yw4l">milk</td>
  </tr>
  <tr>
    <td class="tg-yw4l">2016-01-14</td>
    <td class="tg-yw4l">kate</td>
    <td class="tg-yw4l">book</td>
  </tr>
</table>

<p><hr></p>

<h2>2. datediff</h2>

<p>날짜간 일수 차이를 되돌려주는 함수가 <code>datediff</code>다. MySQL나 HiveQL에서 공통적으로 사용되는 녀석인데 약간의 차이가 또 있다. 예를 들어 다음과 같은 테이블이 있다고 하자. </p>

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;}
.tg td{font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;}
.tg th{font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;}
.tg .tg-yw4l{vertical-align:top}
</style>

<table class="tg">
  <tr>
    <th class="tg-031e">date</th>
    <th class="tg-yw4l">customer</th>
  </tr>
  <tr>
    <td class="tg-yw4l">2016-01-14 12:00:00</td>
    <td class="tg-yw4l">john</td>
  </tr>
  <tr>
    <td class="tg-yw4l">2016-01-14 14:00:10</td>
    <td class="tg-yw4l">john</td>
  </tr>
</table>

<p><br></p>

<p>다시 마트에 존이라는 사람이 언제 입장하고 퇴장했는지를 기록한 테이블이다. 첫번째 행은 입장시간을 두번째 행을 퇴장시간이라고 한다. MySQL에서는 <code>datediff</code>와 비슷하게 시간차를 계산해주는 <code>timediff</code> 함수로 이를 손쉽게 처리할 수 있다. 그러나 HiveQL은 이 기능을 지원하지 않는 듯 하다.. (있으면 알려주세요..)</p>

<p>대신 이를 우회해서 처리할 수 있는 방법이 있다. 바로 스트링으로 된 시간을 <code>unix_timestamp</code>로 변환해서 차이를 계산하는 방식이다. 다음과 같이 계산하면 된다.</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span></span><span class="k">SELECT</span> <span class="o">*</span><span class="p">,</span> <span class="n">UNIX_TIMESTAMP</span><span class="p">(</span><span class="nb">date</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">sample_dataset</span></code></pre></figure>

<p>이렇게 실행하면 144894...같은 긴 숫자가 나온다. 이 숫자는 단위가 <code>초</code>이므로 뒤의 시간에서 앞의 시간을 빼주면 된다. 단 HiveQL에서 빼는 연산을 수행하기 위해서는 <code>lead</code>나 <code>lag</code>를 사용하여 같은 row상에 데이터가 존재하도록 변형을 해줘야 한다. </p>

<p><hr></p>

<h2>3. Lead, Lag</h2>

<p>바로 앞에서 date를 unix_timestamp로 전환하는데 성공했다. 그럼 이 두가지 시간의 차를 어떻게 HiveQL에서 구할 수 있을까. <code>lead</code>와 <code>lag</code>를 써야 한다. <code>lead</code>는 간단히 말해서 앞으로 땡겨오는 것이고 <code>lag</code>는 뒤로 한칸씩 미는 방식이다. 다음과 같은 조금 더 복잡한 예시를 보자.</p>

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;}
.tg td{font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;}
.tg th{font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;}
.tg .tg-yw4l{vertical-align:top}
</style>

<table class="tg">
  <tr>
    <th class="tg-031e">unix_timestamp</th>
    <th class="tg-yw4l">area</th>
    <th class="tg-yw4l">customer</th>
  </tr>
  <tr>
    <td class="tg-yw4l">100</td>
    <td class="tg-yw4l">food</td>
    <td class="tg-yw4l">john</td>
  </tr>
  <tr>
    <td class="tg-yw4l">101</td>
    <td class="tg-yw4l">grocery</td>
    <td class="tg-yw4l">john</td>
  </tr>
  <tr>
    <td class="tg-yw4l">110</td>
    <td class="tg-yw4l">clothes</td>
    <td class="tg-yw4l">john</td>
  </tr>
  <tr>
    <td class="tg-yw4l">201</td>
    <td class="tg-yw4l">food</td>
    <td class="tg-yw4l">mark</td>
  </tr>
</table>

<p><br></p>

<p><code>unix_timestamp</code>를 간소화시킨 형태의 컬럼과 고객이 2명이 있다고 하자. 대형 백화점에서 마트안에서 food와 grocery와 clothes 섹션에 입장한 시간이 각 행의 정보라고 하자. 그러면 John이라는 고객이 food라는 공간에 머문 시간은 입장 시간인 100에서 grocery에 입장한 시간이 101의 차이, 즉 1초가 된다. (물론 일반적으론 1초만 머물진 않겠지만 예시이므로.) 이 때 HiveQL에서 연산을 해주려면 같은 행에 시작시간과 끝시간이 존재해야 한다. 그 다음에 있는 레코드에서 정보를 가져와 하나씩 올리는 것이므로, <code>lead</code>를 사용하기로 한다. 그런데 단순히 올리는 것이 아니라 고객에 따라 분류를 해줘야 한다. 만약 고객으로 group by를 하지 않고 <code>lead</code>를 쓴다면, mark의 시작시간이 john의 clothes 시간의 종료시간이 되어버린다.</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span></span><span class="k">SELECT</span> <span class="o">*</span><span class="p">,</span> <span class="n">LEAD</span><span class="p">(</span><span class="n">unix_timestamp</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">customer</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">unix_timestamp</span><span class="p">)</span> <span class="k">AS</span> <span class="n">next_unix_timestamp</span>
<span class="k">FROM</span> <span class="n">sample_dataset</span></code></pre></figure>

<p><code>PARTITION BY</code>는 <code>LEAD</code>가 적용될 파티션을 정의한다. 그리고 리드를 하기 전에 <code>unix_timestamp</code>로 정렬을 해준다. 그리고 이름을 <code>next_unix_timestamp</code>로 정해준다.
그러면 다음과 같은 테이블이 생성된다.</p>

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;}
.tg td{font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;}
.tg th{font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;}
.tg .tg-yw4l{vertical-align:top}
</style>

<table class="tg">
  <tr>
    <th class="tg-031e">unix_timestamp</th>
    <th class="tg-yw4l">area</th>
    <th class="tg-yw4l">customer</th>
    <th class="tg-yw4l">next_unix_timestamp</th>
  </tr>
  <tr>
    <td class="tg-yw4l">100</td>
    <td class="tg-yw4l">food</td>
    <td class="tg-yw4l">john</td>
    <td class="tg-yw4l">101</td>
  </tr>
  <tr>
    <td class="tg-yw4l">101</td>
    <td class="tg-yw4l">grocery</td>
    <td class="tg-yw4l">john</td>
    <td class="tg-yw4l">110</td>
  </tr>
  <tr>
    <td class="tg-yw4l">110</td>
    <td class="tg-yw4l">clothes</td>
    <td class="tg-yw4l">john</td>
    <td class="tg-yw4l">null</td>
  </tr>
  <tr>
    <td class="tg-yw4l">201</td>
    <td class="tg-yw4l">food</td>
    <td class="tg-yw4l">mark</td>
    <td class="tg-yw4l">null</td>
  </tr>
</table>

<p><br></p>

<p>앞서 설명했던 바와 같이 하나씩 올라와서 <code>next_unix_timestamp</code>로 저장되었다. 3번째와 4번째 열에는 null값이 주어지는데, 단순히 <code>lead</code>로 끌어올 값이 없기 때문이다. 이제 바로 sql에서 쉽게 <code>next_unix_timestamp</code>에서 <code>unix_timestamp</code>를 빼주면 된다. <code>lag</code>는 <code>lead</code>의 반대로 적용된다.</p>

        </section>
        <footer class="post-footer">
          <section class="share">
            
              
                <a class="icon-twitter" href="http://twitter.com/share?text=HiveQL+-+Useful+Tips&amp;url=http://localhost:4000/sql/2016/01/14/hiveQL"
                  onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
                <i class="fa fa-twitter"></i><span class="hidden">twitter</span>
                </a>
              
            
              
            
          </section>
        </footer>
        <div class="bottom-teaser cf">
          <div class="isLeft">
            <h5 class="index-headline featured"><span>Written by</span></h5>
            <section class="author">
              <div class="author-image" style="background-image: url(/assets/images/author.jpg)">Blog Logo</div>
              <h4>Junsik Whang</h4>
              <p class="bio"></p>
              <hr>
              <p class="published">Published <time datetime="2016-01-14 07:34">14 Jan 2016</time></p>
            </section>
          </div>
          
          <div class="isRight">
            <h5 class="index-headline featured"><span>Supported by</span></h5>
            <footer class="site-footer">
              <section class="poweredby">Proudly published with <a href="http://jekyllrb.com"> Jekyll</a></section>
              <a class="subscribe" href="/feed.xml"> <span class="tooltip"> <i class="fa fa-rss"></i> You should subscribe to my feed.</span></a>
              <div class="inner">
                <section class="copyright">All content copyright <a href="/">Junsik Whang</a> &copy; 2017<br>All rights reserved.</section>
              </div>
            </footer>
          </div>
        </div>
      </article>
    </main>
    <div class="bottom-closer">
      <div class="background-closer-image"  style="background-image: url(/assets/images/cA4aKEIPQrerBnp1yGHv_IMG_9534-3-2.jpg)">
        Image
      </div>
      <div class="inner">
        <h1 class="blog-title">jsideas</h1>
        <h2 class="blog-description">a novice's journey into data science
</h2>
        <a href="/" class="btn">Back to Overview</a>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/assets/js/index.js"></script>
<script type="text/javascript" src="/assets/js/readingTime.min.js"></script>
<script>
(function ($) {
  "use strict";
  $(document).ready(function(){

    var $window = $(window),
    $image = $('.post-image-image, .teaserimage-image');
    
      $window.on('scroll', function() {
        var top = $window.scrollTop();

        if (top < 0 || top > 1500) { return; }
        $image
          .css('transform', 'translate3d(0px, '+top/3+'px, 0px)')
          .css('opacity', 1-Math.max(top/700, 0));
      });
      $window.trigger('scroll');

      var height = $('.article-image').height();
      $('.post-content').css('padding-top', height + 'px');

      $('a[href*=#]:not([href=#])').click(function() {
        if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'')
         && location.hostname == this.hostname) {
          var target = $(this.hash);
          target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
          if (target.length) {
            $('html,body').animate({ scrollTop: target.offset().top }, 500);
            return false;
          }
        }
      });

  });
}(jQuery));
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-36651119-2', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>
